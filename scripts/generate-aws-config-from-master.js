#!/usr/bin/env node
/**
 * generate-aws-config-from-master.js
 *
 * Usage:
 *   node scripts/generate-aws-config-from-master.js
 *
 * Reads src/aws-exports.js (generated by `amplify pull`) and produces:
 *   - scripts/dev-env.sh            (NOT to be committed)
 *   - src/aws-exports.deployment.js (env-driven, safe to commit)
 *
 * src/aws-exports.js remains your master and should NOT be committed.
 */

const fs = require("fs");
const path = require("path");

const rootDir = path.join(__dirname, "..");
const masterPath = path.join(rootDir, "src", "aws-exports.js");
const devEnvPath = path.join(rootDir, "scripts", "dev-env.sh");
const deployPath = path.join(rootDir, "src", "aws-exports.deployment.js");

if (!fs.existsSync(masterPath)) {
  console.error(
    `ERROR: ${masterPath} not found.\n` +
      "Run `amplify pull` first so Amplify generates src/aws-exports.js."
  );
  process.exit(1);
}

const source = fs.readFileSync(masterPath, "utf8");

// Extract the awsmobile object literal from the Amplify file
const match = source.match(
  /const\s+awsmobile\s*=\s*({[\s\S]*?});\s*export default/s
);

if (!match) {
  console.error(
    "ERROR: Could not find `const awsmobile = { ... }; export default awsmobile;` " +
      "in src/aws-exports.js."
  );
  process.exit(1);
}

const objLiteral = match[1];
let awsmobile;

try {
  // IMPORTANT: we only eval the object literal, not arbitrary code.
  awsmobile = eval("(" + objLiteral + ")");
} catch (err) {
  console.error("ERROR: Failed to eval awsmobile object from aws-exports.js:");
  console.error(err);
  process.exit(1);
}

// ---- Map master config -> env vars ----------------------------------------

const env = {};

env.GATSBY_AWS_REGION = awsmobile.aws_project_region;
env.GATSBY_USER_POOL_ID = awsmobile.aws_user_pools_id;
env.GATSBY_USER_POOL_CLIENT_ID = awsmobile.aws_user_pools_web_client_id;

if (awsmobile.aws_cognito_identity_pool_id) {
  env.GATSBY_IDENTITY_POOL_ID = awsmobile.aws_cognito_identity_pool_id;
}

if (awsmobile.aws_appsync_graphqlEndpoint) {
  env.GATSBY_APPSYNC_ENDPOINT = awsmobile.aws_appsync_graphqlEndpoint;
}
if (awsmobile.aws_appsync_authenticationType) {
  env.GATSBY_APPSYNC_AUTH_TYPE = awsmobile.aws_appsync_authenticationType;
}

// OAuth / Hosted UI
if (awsmobile.oauth) {
  env.GATSBY_COGNITO_OAUTH_DOMAIN = awsmobile.oauth.domain;
  env.GATSBY_COGNITO_OAUTH_REDIRECT_SIGNIN = awsmobile.oauth.redirectSignIn;
  env.GATSBY_COGNITO_OAUTH_REDIRECT_SIGNOUT = awsmobile.oauth.redirectSignOut;
  if (Array.isArray(awsmobile.oauth.scope)) {
    env.GATSBY_COGNITO_OAUTH_SCOPES = awsmobile.oauth.scope.join(",");
  }
  if (awsmobile.oauth.responseType) {
    env.GATSBY_COGNITO_OAUTH_RESPONSETYPE = awsmobile.oauth.responseType;
  }
}

// Social providers (Google etc.)
if (Array.isArray(awsmobile.aws_cognito_social_providers)) {
  env.GATSBY_COGNITO_SOCIAL_PROVIDERS =
    awsmobile.aws_cognito_social_providers.join(",");
}

// ---- Generate scripts/dev-env.sh -----------------------------------------

fs.mkdirSync(path.dirname(devEnvPath), { recursive: true });

const orderedEnvKeys = Object.keys(env).sort();

const devEnvLines = [];
devEnvLines.push("#!/usr/bin/env bash");
devEnvLines.push(
  "# Auto-generated from src/aws-exports.js by scripts/generate-aws-config-from-master.js"
);
devEnvLines.push("# DO NOT COMMIT this file.");
devEnvLines.push("#");
devEnvLines.push("# Amplify Gen2 environment variables (copy/paste into console):");
devEnvLines.push("#");

for (const key of orderedEnvKeys) {
  devEnvLines.push(`# ${key}=${env[key]}`);
}

devEnvLines.push("");
devEnvLines.push("# Local dev exports:");
for (const key of orderedEnvKeys) {
  devEnvLines.push(`export ${key}="${env[key]}"`);
}

devEnvLines.push("");
devEnvLines.push('echo "[dev-env] Environment variables set for DigitalHome.Cloud portal."');
devEnvLines.push('echo "[dev-env] Now run: npm run develop"');

fs.writeFileSync(devEnvPath, devEnvLines.join("\n"), { mode: 0o700 });
console.log(`Wrote ${devEnvPath}`);

// ---- Generate src/aws-exports.deployment.js -------------------------------

fs.mkdirSync(path.dirname(deployPath), { recursive: true });

// Defaults for scopes / response type / social providers, taken from master
const defaultScopes =
  awsmobile.oauth && Array.isArray(awsmobile.oauth.scope)
    ? awsmobile.oauth.scope
    : ["phone", "email", "openid", "profile", "aws.cognito.signin.user.admin"];

const defaultResponseType =
  (awsmobile.oauth && awsmobile.oauth.responseType) || "code";

const defaultSocialProviders =
  awsmobile.aws_cognito_social_providers || ["GOOGLE"];

// NOTE: we deliberately DO NOT include aws_appsync_apiKey here.
// Any API key in the frontend is public. Use Cognito/IAM for AppSync auth.

const deployLines = [];
deployLines.push("/* eslint-disable */");
deployLines.push("// Environment-driven aws-exports for deployment.");
deployLines.push(
  "// Generated from src/aws-exports.js by scripts/generate-aws-config-from-master.js"
);
deployLines.push("");
deployLines.push("const getScopes = () => {");
deployLines.push("  const raw = process.env.GATSBY_COGNITO_OAUTH_SCOPES;");
deployLines.push(
  "  if (!raw) return " + JSON.stringify(defaultScopes, null, 2) + ";"
);
deployLines.push(
  "  return raw.split(',').map((s) => s.trim()).filter(Boolean);"
);
deployLines.push("};");
deployLines.push("");
deployLines.push("const getSocialProviders = () => {");
deployLines.push("  const raw = process.env.GATSBY_COGNITO_SOCIAL_PROVIDERS;");
deployLines.push(
  "  if (!raw) return " + JSON.stringify(defaultSocialProviders, null, 2) + ";"
);
deployLines.push(
  "  return raw.split(',').map((s) => s.trim()).filter(Boolean);"
);
deployLines.push("};");
deployLines.push("");
deployLines.push("const awsmobile = {");
deployLines.push("  aws_project_region: process.env.GATSBY_AWS_REGION,");
deployLines.push(
  "  aws_cognito_identity_pool_id: process.env.GATSBY_IDENTITY_POOL_ID,"
);
deployLines.push("  aws_cognito_region: process.env.GATSBY_AWS_REGION,");
deployLines.push("  aws_user_pools_id: process.env.GATSBY_USER_POOL_ID,");
deployLines.push(
  "  aws_user_pools_web_client_id: process.env.GATSBY_USER_POOL_CLIENT_ID,"
);

// oauth
deployLines.push("  oauth: {");
deployLines.push("    domain: process.env.GATSBY_COGNITO_OAUTH_DOMAIN,");
deployLines.push("    scope: getScopes(),");
deployLines.push(
  "    redirectSignIn: process.env.GATSBY_COGNITO_OAUTH_REDIRECT_SIGNIN,"
);
deployLines.push(
  "    redirectSignOut: process.env.GATSBY_COGNITO_OAUTH_REDIRECT_SIGNOUT,"
);
deployLines.push(
  "    responseType: process.env.GATSBY_COGNITO_OAUTH_RESPONSETYPE || " +
    JSON.stringify(defaultResponseType) +
    ","
);
deployLines.push("  },");

// keep structural settings from master where relevant
if (awsmobile.federationTarget) {
  deployLines.push(
    "  federationTarget: " + JSON.stringify(awsmobile.federationTarget) + ","
  );
}

if (awsmobile.aws_cognito_username_attributes) {
  deployLines.push(
    "  aws_cognito_username_attributes: " +
      JSON.stringify(awsmobile.aws_cognito_username_attributes) +
      ","
  );
}
if (awsmobile.aws_cognito_mfa_configuration) {
  deployLines.push(
    "  aws_cognito_mfa_configuration: " +
      JSON.stringify(awsmobile.aws_cognito_mfa_configuration) +
      ","
  );
}
if (awsmobile.aws_cognito_mfa_types) {
  deployLines.push(
    "  aws_cognito_mfa_types: " +
      JSON.stringify(awsmobile.aws_cognito_mfa_types) +
      ","
  );
}
if (awsmobile.aws_cognito_password_protection_settings) {
  deployLines.push(
    "  aws_cognito_password_protection_settings: " +
      JSON.stringify(awsmobile.aws_cognito_password_protection_settings) +
      ","
  );
}
if (
  awsmobile.aws_cognito_signup_attributes ||
  awsmobile.aws_cognito_sign_up_attributes
) {
  deployLines.push(
    "  aws_cognito_signup_attributes: " +
      JSON.stringify(
        awsmobile.aws_cognito_signup_attributes ||
          awsmobile.aws_cognito_sign_up_attributes
      ) +
      ","
  );
}

// social providers (from env, with fallback)
deployLines.push("  aws_cognito_social_providers: getSocialProviders(),");

// AppSync (no API key)
if (awsmobile.aws_appsync_graphqlEndpoint) {
  deployLines.push(
    "  aws_appsync_graphqlEndpoint: process.env.GATSBY_APPSYNC_ENDPOINT,"
  );
  deployLines.push("  aws_appsync_region: process.env.GATSBY_AWS_REGION,");
  deployLines.push(
    "  aws_appsync_authenticationType: process.env.GATSBY_APPSYNC_AUTH_TYPE || " +
      JSON.stringify(
        awsmobile.aws_appsync_authenticationType ||
          "AMAZON_COGNITO_USER_POOLS"
      ) +
      ","
  );
}

// Geo / maps (not secrets)
if (awsmobile.geo) {
  deployLines.push(
    "  geo: " + JSON.stringify(awsmobile.geo, null, 2).replace(/\n/g, "\n  ") + ","
  );
}

// User files S3 (not secret; can be env-ified later if needed)
if (awsmobile.aws_user_files_s3_bucket) {
  deployLines.push(
    "  aws_user_files_s3_bucket: " +
      JSON.stringify(awsmobile.aws_user_files_s3_bucket) +
      ","
  );
}
if (awsmobile.aws_user_files_s3_bucket_region) {
  deployLines.push(
    "  aws_user_files_s3_bucket_region: " +
      JSON.stringify(awsmobile.aws_user_files_s3_bucket_region) +
      ","
  );
}

deployLines.push("};");
deployLines.push("");
deployLines.push("export default awsmobile;");

fs.writeFileSync(deployPath, deployLines.join("\n"));
console.log(`Wrote ${deployPath}`);

console.log("\nDone. Next steps:");
console.log("  - Use src/aws-exports.js only locally (untracked).");
console.log("  - Commit src/aws-exports.deployment.js.");
console.log("  - Do NOT commit scripts/dev-env.sh.");

