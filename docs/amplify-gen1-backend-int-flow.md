# Amplify Gen1 Backend ↔ Gen2 Frontend Integration Flow

This document describes how the DigitalHome.Cloud portal (Amplify Gen2
frontend) integrates with the shared Amplify Gen1 backend, using
`aws-exports.js` as the single source of truth while keeping secrets
out of the Git repository and deployed frontend.

---

## Components

- **Amplify Gen1 backend**
  - Manages Cognito User Pool, Identity Pool, AppSync, S3, etc.
  - Generates `src/aws-exports.js` via `amplify pull`.
- **Amplify Gen2 frontend (portal)**
  - Gatsby-based portal hosted via Amplify Gen2.
  - Uses an env-driven config file:
    - `src/aws-exports.deployment.js` (committed)
  - Reads all sensitive identifiers from environment variables prefixed
    with `GATSBY_`.

---

## Files

### Master config (local only, NOT committed)

- `src/aws-exports.js`
  - Generated by `amplify pull` in the Gen1 backend project.
  - Contains full Amplify config, including:
    - Region
    - Cognito User Pool ID & client ID
    - Identity Pool ID
    - AppSync GraphQL endpoint & auth mode
    - OAuth / Hosted UI settings (domain, scopes, redirects)
    - Social providers (e.g. Google)
    - S3 bucket names
    - **AppSync API key (not used in deployment)**

### Generated helper files

- `scripts/dev-env.sh` (**local only, NOT committed**)
  - Generated from `src/aws-exports.js` by:
    - `node scripts/generate-aws-config-from-master.js`
  - Contains:
    - A commented header with all environment variable
      `KEY=value` pairs for Amplify Gen2.
    - `export` commands for local development.
  - Usage:
    ```bash
    source scripts/dev-env.sh
    npm run develop
    ```

- `src/aws-exports.deployment.js` (**committed**)
  - Env-driven version of the Amplify config.
  - Uses `process.env.GATSBY_*` variables for all dynamic values:
    - Region, user pool, identity pool
    - AppSync endpoint & auth type
    - Hosted UI domain / redirects / scopes
    - Social providers list
  - **AppSync API key is intentionally omitted.**
  - Imported by Gatsby instead of the master file:
    ```js
    import awsExports from "./src/aws-exports.deployment";
    ```

### Script

- `scripts/generate-aws-config-from-master.js`
  - Reads `src/aws-exports.js`.
  - Extracts the `awsmobile` object.
  - Generates:
    - `scripts/dev-env.sh`
    - `src/aws-exports.deployment.js`

---

## Workflow

### 1. Backend change (Gen1)

When you change the Amplify Gen1 backend (e.g. new User Pool, updated
OAuth settings, new AppSync endpoint):

1. In the backend project (or wherever you have Amplify CLI configured),
   run:
   ```bash
   amplify pull
   ```
   This updates `src/aws-exports.js` with the new config.

2. Copy or sync the updated `src/aws-exports.js` into the portal repo
   (same path: `src/aws-exports.js`).

3. In the portal repo, regenerate the env + deployment config:
   ```bash
   node scripts/generate-aws-config-from-master.js
   ```

   This writes:
   - `scripts/dev-env.sh` (local env helper)
   - `src/aws-exports.deployment.js` (env-based config for build)

4. Add and commit:
   ```bash
   git add src/aws-exports.deployment.js scripts/generate-aws-config-from-master.js
   git commit -m "Update env-driven Amplify config from master aws-exports"
   ```

   Do **not** commit:
   - `src/aws-exports.js`
   - `scripts/dev-env.sh`

---

### 2. Local development

1. Ensure `src/aws-exports.js` is present (from `amplify pull`) and the
   generator has been run.

2. In the portal repo:
   ```bash
   source scripts/dev-env.sh
   npm run develop
   ```

3. Gatsby picks up all `GATSBY_*` variables and uses
   `src/aws-exports.deployment.js` (which reads from `process.env`).

---

### 3. Amplify Gen2 deployment

In the Amplify Gen2 console for the portal app:

1. Configure environment variables under:
   **Build settings → Environment variables**

   Use the `# KEY=value` lines at the top of `scripts/dev-env.sh` as
   the canonical list and source of values:
   - `GATSBY_AWS_REGION`
   - `GATSBY_USER_POOL_ID`
   - `GATSBY_USER_POOL_CLIENT_ID`
   - `GATSBY_IDENTITY_POOL_ID`
   - `GATSBY_APPSYNC_ENDPOINT`
   - `GATSBY_APPSYNC_AUTH_TYPE`
   - `GATSBY_COGNITO_OAUTH_DOMAIN`
   - `GATSBY_COGNITO_OAUTH_REDIRECT_SIGNIN`
   - `GATSBY_COGNITO_OAUTH_REDIRECT_SIGNOUT`
   - `GATSBY_COGNITO_OAUTH_SCOPES`
   - `GATSBY_COGNITO_OAUTH_RESPONSETYPE`
   - `GATSBY_COGNITO_SOCIAL_PROVIDERS`

2. The `amplify.yml` for the portal is minimal:

   ```yaml
   version: 1
   frontend:
     phases:
       preBuild:
         commands:
           - npm ci || npm install
       build:
         commands:
           - npm run build
     artifacts:
       baseDirectory: public
       files:
         - "**/*"
     cache:
       paths:
         - node_modules/**/*
   ```

3. During build:
   - Gatsby imports `src/aws-exports.deployment.js`.
   - That file reads `process.env.GATSBY_*` set by Amplify.
   - The HTML/JS bundle contains only the identifiers necessary
     for the frontend, but no hard-coded API keys.

---

## Security Considerations

- `src/aws-exports.js` (master) may contain:
  - AppSync API keys
  - Other values not intended for public use
- This file:
  - Must **never** be committed to Git.
  - Must **never** be used by the deployed frontend.
- The deployment config (`src/aws-exports.deployment.js`) is safe to
  commit because:
  - It reads dynamic values from environment variables.
  - API keys are deliberately excluded.
- Any secret that the frontend can see is effectively public. Use
  Cognito or IAM for AppSync auth instead of API key auth wherever
  possible.

---

## Summary

- **Gen1 backend** remains the source of truth for AWS resources.
- **`src/aws-exports.js`** (from `amplify pull`) is the master config,
  kept local.
- **`scripts/generate-aws-config-from-master.js`** translates that
  config into:
  - A local dev env script (`scripts/dev-env.sh`).
  - A deployment-friendly config (`src/aws-exports.deployment.js`).
- **Gen2 frontend** (portal) imports only the env-driven deployment
  config and reads all sensitive IDs via `GATSBY_*` environment
  variables configured in Amplify.
